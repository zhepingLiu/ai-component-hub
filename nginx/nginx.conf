user  nginx;
worker_processes  auto;
events { worker_connections 1024; }

http {
    log_format json_combined escape=json
        '{'
            '"ts":"$time_iso8601",'
            '"remote_addr":"$remote_addr",'
            '"method":"$request_method",'
            '"path":"$uri",'
            '"status":$status,'
            '"request_time":$request_time,'
            '"body_bytes_sent":$body_bytes_sent,'
            '"request_id":"$http_x_request_id",'
            '"trace_id":"$http_x_trace_id",'
            '"upstream_addr":"$upstream_addr",'
            '"upstream_time":"$upstream_response_time"'
        '}';

    upstream gateway {
        server gateway:8000;
    }

    server {
        listen 80;
        server_name _;

        access_log /var/log/nginx/access.log json_combined;

        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        location / {
            proxy_pass http://gateway;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Request-Id $http_x_request_id;
            proxy_set_header X-Trace-Id $http_x_trace_id;
        }
    }
}
